<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A WebChuGL application">
    <title>{{{ TITLE }}}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }

        /* ── Loading screen ────────────────────────────── */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #loading-screen.hidden { display: none; }
        .loading-logo {
            width: 50%;
            max-width: 800px;
            height: auto;
            margin-bottom: 32px;
        }
        #loading-logo-dark { display: none; }
        #progress-bar {
            width: 50%;
            max-width: 800px;
            height: 2em;
            border: 4px solid #f18e29;
            background: #fff;
        }
        #progress-fill {
            height: 100%;
            width: 0%;
            background: #4f9019;
            transition: width 0.15s;
        }
        @media (prefers-color-scheme: dark) {
            #loading-screen { background: #000; }
            #progress-bar { background: #000; }
            #loading-logo-light { display: none; }
            #loading-logo-dark { display: block; }
        }
        #error-text {
            margin-top: 16px;
            color: #c00;
            font-family: monospace;
            font-size: 14px;
            display: none;
        }

        /* ── Audio hint ────────────────────────────────── */
        #audio-hint {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: #888;
            font-family: monospace;
            font-size: 12px;
            z-index: 5;
            transition: opacity 0.5s;
        }
        #audio-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen">
        <img id="loading-logo-light" class="loading-logo" src="./assets/chugl_logo_light.png" alt="ChuGL" fetchpriority="high">
        <img id="loading-logo-dark" class="loading-logo" src="./assets/chugl_logo_dark.png" alt="ChuGL" fetchpriority="high">
        <div id="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Loading progress"><div id="progress-fill"></div></div>
        <div id="error-text"></div>
    </div>

    <canvas id="canvas" tabindex="0"></canvas>

    <div id="audio-hint">Click to enable audio</div>

    <script>
        // WebGPU check — set a flag so the module script can bail out
        window._webgpuAvailable = !!navigator.gpu;
        if (!navigator.gpu) {
            document.getElementById('progress-bar').style.display = 'none';
            var errEl = document.getElementById('error-text');
            errEl.textContent = 'WebGPU is not supported in this browser. Please use Chrome, Edge, or Firefox Nightly.';
            errEl.style.display = 'block';
        }

        // Prevent context menu on canvas
        document.getElementById('canvas').addEventListener('contextmenu', function(e) { e.preventDefault(); });

        // Hide audio hint on first interaction
        var audioHint = document.getElementById('audio-hint');
        var hideAudioHint = function() { audioHint.classList.add('hidden'); };
        document.addEventListener('click', hideAudioHint, { once: true });
        document.addEventListener('keydown', hideAudioHint, { once: true });
        document.addEventListener('touchstart', hideAudioHint, { once: true });
    </script>
    <script type="module">
        if (!window._webgpuAvailable) {
            // Don't attempt WASM init without WebGPU
        } else {
            try {
                var { default: ChuGL } = await import('https://cdn.jsdelivr.net/npm/webchugl/+esm');

                var ck = await ChuGL.init({
                    canvas: document.getElementById('canvas'),
                    onProgress: function(pct) {
                        var el = document.getElementById('progress-fill');
                        if (el) el.style.width = Math.round(pct) + '%';
                        var bar = document.getElementById('progress-bar');
                        if (bar) bar.setAttribute('aria-valuenow', Math.round(pct));
                    },
                    onError: function(msg) {
                        console.error('[WebChuGL] ' + msg);
                        var pb = document.getElementById('progress-bar');
                        if (pb) pb.style.display = 'none';
                        var errEl = document.getElementById('error-text');
                        if (errEl) {
                            errEl.textContent = msg;
                            errEl.style.display = 'block';
                        }
                    },
                });

                await ck.runZip('./bundle.zip', '{{{ MAIN_FILE }}}');

                var ls = document.getElementById('loading-screen');
                if (ls) ls.classList.add('hidden');
                document.getElementById('canvas').focus();
            } catch (e) {
                console.error('[WebChuGL] Init failed:', e);
                var pb = document.getElementById('progress-bar');
                if (pb) pb.style.display = 'none';
                var errEl = document.getElementById('error-text');
                if (errEl) {
                    errEl.textContent = e.message || 'Initialization failed';
                    errEl.style.display = 'block';
                }
            }
        }
    </script>
</body>
</html>
